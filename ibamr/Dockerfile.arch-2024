FROM archlinux:base-20240101.0.204074
MAINTAINER David Wells <drwells@email.unc.edu>

##
## I. Configure pacman
##
RUN                                                                    \
  echo 'Server = http://mirror.cs.vt.edu/pub/ArchLinux/$repo/os/$arch' \
      >/etc/pacman.d/mirrorlist                               &&       \
  echo 'Server = http://mirror.cs.pitt.edu/ArchLinux/$repo/os/$arch'   \
      >>/etc/pacman.d/mirrorlist

##
## II. Build and install dependencies
##
##   A. things from pacman
##
RUN                                                                            \
  pacman --noconfirm -Syu awk bc boost ccache cmake diffutils eigen gcc        \
      fakeroot gcc-fortran grep git hdf5-openmpi lapack lua m4 make mold       \
      muparser netcdf openmpi patch pcre python sed sudo superlu               \
      which wget zlib     &&                                                   \
  pacman --noconfirm -Scc &&                                                   \
  find /var/cache/pacman  -delete

##
##   B. Things from the AUR.
##       1. Start by adding a build user with password pw
##       2. Add everyone in wheel to sudoers
##
##   Obviously this has major security considerations - don't do this
##   outside of docker
##
RUN                                                               \
  useradd --password "$(perl -e 'print crypt('pw', "password")')" \
          --groups users,wheel build                           && \
  mkdir -p /build                                              && \
  chown build:users /build                                     && \
  sed -i 's/# %wheel/%wheel/' /etc/sudoers

##
##       3. install dependencies via AUR - try to avoid openmp in hypre and also
##       downgrade it to prevent a conflict with PETSc 3.19 (fixed in PETSc
##       3.20). Also turn off petsc4py (it doesn't work with cython 3). Delete
##       the PETSc examples (this folder is 55 MB of a total of 1.6 GB and we
##       don't need it)
##
USER build
RUN                                                                         \
  export MAKEFLAGS="-j4"                                                 && \
  cd /build                                                              && \
  for PKG in numdiff gklib metis parmetis-git superlu_dist hypre petsc   ;  \
  do                                                                        \
      wget https://aur.archlinux.org/cgit/aur.git/snapshot/$PKG.tar.gz   && \
      tar xf $PKG.tar.gz                                                 && \
      pushd $PKG                                                         && \
      if [ "$PKG" = "hypre" ] ; then                                        \
        sed -i 's/-fopenmp//g' PKGBUILD                                  && \
        sed -i '/--with-openmp/d' PKGBUILD                               ;  \
      fi                                                                 && \
      if [ "$PKG" = "petsc" ] ; then                                        \
        sed -i 's/LDFLAGS=$LDFLAGS/LDFLAGS=-lstdc++/' PKGBUILD           && \
        sed -i "s/'python-numpy'//" PKGBUILD                             && \
        sed -i "s/'python-mpi4py'//" PKGBUILD                            && \
        sed -i "s/with-mpi-f90module-visibility=0/with-fortran-bindings=0/" PKGBUILD && \
        sed -i "s/'cython'//" PKGBUILD                                   && \
        sed -i "s/'fftw'//" PKGBUILD                                     && \
        sed -i '/--with-fftw/d' PKGBUILD                                 && \
        sed -i "s/'gsl'//" PKGBUILD                                      && \
        sed -i '/--with-gsl/d' PKGBUILD                                  && \
        sed -i "s/'suitesparse'//" PKGBUILD                              && \
        sed -i '/--with-suitesparse/d' PKGBUILD                          && \
        sed -i "s/'libyaml'//" PKGBUILD                                  && \
        sed -i '/--with-yaml/d' PKGBUILD                                 && \
        sed -i "s/'libjpeg-turbo'//" PKGBUILD                            && \
        sed -i '/--with-libjpeg/d' PKGBUILD                              && \
        sed -i "s/'netcdf-openmpi'//" PKGBUILD                           && \
        sed -i '/--with-netcdf/d' PKGBUILD                               && \
        sed -i "s/'zfp'//" PKGBUILD                                      && \
        sed -i '/--with-zfp/d' PKGBUILD                                  && \
        sed -i '/provides.*petsc4py/d' PKGBUILD                          && \
        sed -i 's/petsc4py=1/petsc4py=0/' PKGBUILD                       && \
        sed -i 's/make check//' PKGBUILD                                 ;  \
      fi                                                                 && \
      makepkg                                                            && \
      echo "pw" | sudo -S pacman --noconfirm -U $PKG*zst                 && \
      popd                                                               && \
      rm -rf $PKG ;                                                         \
  done                                                                   && \
  echo "pw" | sudo -S rm -rf /opt/petsc/linux-c-opt/share/petsc/examples && \
  cd /                                                                   && \
  echo "pw" | sudo -S rm -rf /build

##
##   C. install SAMRAI (our sole non-standard dependency)
##
USER root
RUN                                                                     \
  mkdir /samrai                                                      && \
  mkdir -p /build/                                                   && \
  cd /build/                                                         && \
  wget https://github.com/IBAMR/IBSAMRAI2/archive/refs/tags/2024.02.22.tar.gz && \
  tar xf 2024.02.22.tar.gz                                           && \
  cd IBSAMRAI2-2024.02.22                                            && \
  mkdir build                                                        && \
  cd build                                                           && \
  ../configure                                                          \
      CFLAGS="-O2 -fPIC"                                                \
      CXXFLAGS="-O2 -fPIC"                                              \
      FFLAGS="-O2 -fPIC"                                                \
      --prefix=/samrai                                                  \
      --with-F77=$(which gfortran)                                      \
      --without-hypre                                                   \
      --without-silo                                                    \
      --without-blaslapack                                              \
      --without-cubes                                                   \
      --without-eleven                                                  \
      --without-petsc                                                   \
      --without-sundials                                                \
      --without-x                                                       \
      --without-doxygen                                                 \
      --enable-debug                                                    \
      --enable-dcomplex                                                 \
      --with-hdf5=/usr/                                                 \
      --enable-implicit-template-instantiation                          \
      --disable-deprecated                                           && \
  make -j4                                                           && \
  make -j4 install                                                   && \
  cd /                                                               && \
  rm -rf /build/

##
##   D. install IBAMR
##
RUN                                                                       \
  mkdir /ibamr                                                         && \
  mkdir -p /build/                                                     && \
  cd /build/                                                           && \
  wget https://github.com/IBAMR/IBAMR/archive/refs/tags/v0.14.0.tar.gz && \
  tar xf v0.14.0.tar.gz                                                && \
  cd IBAMR-0.14.0                                                      && \
  mkdir build                                                          && \
  cd build                                                             && \
  cmake -DCMAKE_CXX_FLAGS="-O2"                                           \
        -DCMAKE_Fortran_FLAGS="-O2"                                       \
        -DCMAKE_INSTALL_PREFIX=/ibamr                                     \
        -DNUMDIFF_ROOT=/usr/                                              \
        -DPETSC_ROOT=/opt/petsc/linux-c-opt/                              \
        -DSAMRAI_ROOT=/samrai                                             \
        ../                                                            && \
  make -j4 install                                                     && \
  cd /                                                                 && \
  rm -rf /build/
